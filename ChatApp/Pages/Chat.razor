@page "/Chat"

@using Microsoft.AspNetCore.SignalR.Client; 
@using ChatApp.Hubs; 


@implements IDisposable

@inject NavigationManager _navigationManager; 
<h1>Chat</h1>
<ul>
    @foreach (var message in messages)
    {
        <li>
            @message 
        </li>
    }
</ul> 

@code{ 
        private HubConnection hubConnection; 
        private List<string> messages = new List<string>(); 

        async protected override Task OnInitializedAsync()
        {
            var baseURL = _navigationManager.BaseUri.Trim('/'); 

            var connectionURL = baseURL + ChatHub.hubPath; 
            hubConnection = new HubConnectionBuilder().WithUrl(connectionURL).Build(); 
            hubConnection.On<string, string>("sendMessage", onReceiveMessage); 
            await hubConnection.StartAsync(); 
        }

        public async Task CloseHubConnection(){
            await hubConnection.StopAsync(); 
            await hubConnection.DisposeAsync(); 
            hubConnection = null; 
        }

        public void Dispose(){
            CloseHubConnection(); 
        }

        public void onReceiveMessage(string message, string userName){
            messages.Add(message);
            StateHasChanged(); 
        } 

}

